openapi: 3.0.3
info:
  title: ClawOS Middleware API
  version: 0.2.0
  description: Contracts for agent orchestration, shared memory, voice processing, handoff, and project status.
servers:
  - url: /api
security:
  - bearerAuth: []
paths:
  /agents/spawn:
    post:
      summary: Create a sub-agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SpawnAgentRequest"
      responses:
        "201":
          description: Sub-agent created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpawnAgentResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /agents:
    get:
      summary: List registered agents
      responses:
        "200":
          description: Agent list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentListResponse"
  /agents/{agentId}/status:
    patch:
      summary: Update status for one agent
      parameters:
        - in: path
          name: agentId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateAgentStatusRequest"
      responses:
        "200":
          description: Agent status updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateAgentStatusResponse"
        "400":
          description: Invalid status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /memory/search:
    get:
      summary: Hybrid search in shared memory
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
        - in: query
          name: project_id
          required: false
          schema:
            type: string
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemorySearchResponse"
  /memory/ingest:
    post:
      summary: Ingest a memory event
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MemoryIngestRequest"
      responses:
        "202":
          description: Memory accepted for processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemoryIngestResponse"
  /memory/pin:
    post:
      summary: Pin memory to increase global retrieval priority
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MemoryPinRequest"
      responses:
        "200":
          description: Memory pinned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemoryPinResponse"
  /agents/handoff:
    post:
      summary: Transfer context from one agent to another
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HandoffRequest"
      responses:
        "200":
          description: Handoff complete
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HandoffResponse"
  /voice/process:
    post:
      summary: Process voice input and return transcript plus response
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VoiceProcessRequest"
      responses:
        "200":
          description: Voice pipeline output
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VoiceProcessResponse"
        "400":
          description: Invalid or missing voice payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "413":
          description: Audio payload too large
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: External voice provider runtime failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Voice provider configuration missing or invalid
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /projects/status:
    get:
      summary: Consolidated project status
      parameters:
        - in: query
          name: project_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Project status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectStatusResponse"
  /knowledge/feed:
    get:
      summary: Global discovery feed entries
      parameters:
        - in: query
          name: project_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Feed entries
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KnowledgeFeedResponse"
  /knowledge/graph:
    get:
      summary: Graph data for agents and findings
      parameters:
        - in: query
          name: project_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Graph nodes and edges
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/KnowledgeGraphResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Agent:
      type: object
      required:
        - id
        - name
        - role
        - personality_path
        - voice_id
        - skills
        - memory_access
        - status
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        role:
          type: string
        personality_path:
          type: string
        voice_id:
          type: string
        skills:
          type: array
          items:
            type: string
        memory_access:
          type: string
          enum: [global, private]
        status:
          type: string
          enum: [idle, busy, sleeping]

    SpawnAgentRequest:
      type: object
      required:
        - name
        - role
        - voice_id
        - skills
        - memory_access
      properties:
        name:
          type: string
        role:
          type: string
        personality_template:
          type: string
        voice_id:
          type: string
        skills:
          type: array
          items:
            type: string
        memory_access:
          type: string
          enum: [global, private]

    SpawnAgentResponse:
      type: object
      required:
        - agent
        - files_created
      properties:
        agent:
          $ref: "#/components/schemas/Agent"
        files_created:
          type: array
          items:
            type: string

    AgentListResponse:
      type: object
      properties:
        agents:
          type: array
          items:
            $ref: "#/components/schemas/Agent"

    UpdateAgentStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [idle, busy, sleeping]

    UpdateAgentStatusResponse:
      type: object
      properties:
        agent:
          $ref: "#/components/schemas/Agent"

    MemoryResult:
      type: object
      properties:
        content:
          type: string
        score:
          type: number
          format: float
        priority_score:
          type: number
          format: float
        metadata:
          type: object
          additionalProperties: true

    MemorySearchResponse:
      type: object
      properties:
        query:
          type: string
        results:
          type: array
          items:
            $ref: "#/components/schemas/MemoryResult"

    MemoryIngestRequest:
      type: object
      required:
        - content
        - metadata
      properties:
        content:
          type: string
        priority_score:
          type: number
          format: float
        metadata:
          type: object
          properties:
            agent_id:
              type: string
            project_id:
              type: string
            source:
              type: string
            timestamp:
              type: string
              format: date-time
            tags:
              type: array
              items:
                type: string

    MemoryIngestResponse:
      type: object
      properties:
        status:
          type: string
        memory_id:
          type: string

    MemoryPinRequest:
      type: object
      required:
        - memory_id
      properties:
        memory_id:
          type: string
        reason:
          type: string

    MemoryPinResponse:
      type: object
      properties:
        memory_id:
          type: string
        priority_score:
          type: number
          format: float
        pinned:
          type: boolean

    HandoffRequest:
      type: object
      required:
        - from_agent_id
        - to_agent_id
        - project_id
        - content
      properties:
        from_agent_id:
          type: string
        to_agent_id:
          type: string
        project_id:
          type: string
        content:
          type: string

    HandoffResponse:
      type: object
      properties:
        status:
          type: string
        handoff_id:
          type: string

    VoiceProcessRequest:
      type: object
      required:
        - audio_base64
        - agent_id
      properties:
        audio_base64:
          type: string
          description: Base64 encoded audio clip
        agent_id:
          type: string
        project_id:
          type: string
        voice_id:
          type: string

    VoiceProcessResponse:
      type: object
      properties:
        transcript:
          type: string
        agent_response:
          type: string
        tts_audio_url:
          type: string

    ProjectStatusResponse:
      type: object
      properties:
        project_id:
          type: string
        overall_status:
          type: string
        agents:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              status:
                type: string
        tasks:
          type: object
          additionalProperties:
            type: integer
        updated_at:
          type: string
          format: date-time

    KnowledgeFeedResponse:
      type: object
      properties:
        project_id:
          type: string
        entries:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              agent_id:
                type: string
              message:
                type: string
              timestamp:
                type: string
                format: date-time

    KnowledgeGraphResponse:
      type: object
      properties:
        project_id:
          type: string
        nodes:
          type: array
          items:
            type: object
            additionalProperties: true
        edges:
          type: array
          items:
            type: object
            additionalProperties: true

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true
